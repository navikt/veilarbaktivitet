asyncapi: 2.5.0
info:
  title: Aktivitetskort as a service - AkaaS
  description: |
    Data-drevet grensesnitt for å opprette og endre aktivitetskort i aktivitetsplanen.  
    Løsningen er beregnet på team som har data i sine systemer som skal representeres som en aktivitet i aktivitetsplan, for eksempel tiltaksgjennomføringer. 
    Eksisterende aktiviteter kan oppdateres ved å sende en ny versjon av aktivitetskortet med samme funksjonelle id.  
    Tjenesten har støtte for en rekke dynamiske innholdskomponenter i aktivitetskortet, slik at produsentene på tjenesten har stor grad av kontroll på hvordan aktivitetskortet skal se ut.  
    Dynamiske komponenter inkluderer 'oppgave', 'handlinger', 'detaljer' og 'etiketter'. Disse er beskrevet i skjemaet.  
    [Lenke til Mural](https://app.mural.co/t/navdesign3580/m/navdesign3580/1663573695869/1a7a897ac6b2af3fccc11aa65371a83d840e2020?wid=0-1665572511683&outline=open)
  

  version: '0.0.1'

defaultContentType: application/json

channels:
  aktivitetskort-v1:
    description: Topic for å bestille eller oppdatere aktiviteter i aktivitetsplan
    bindings:
      kafka:
        key:
          type: string
          format: uuid
          description: aktiviteskorts id. Også kalt funksjonell id
    publish:
      message:
        $ref: '#/components/messages/aktivitetskort'


components:
  messages:
    aktivitetskort:
      name: aktivitetskortBestilling
      title: Aktivitetskort bestilling
      summary: Bestilling for oppretting eller endring av et aktivitetskort
      traits:
        - $ref: '#/components/messageTraits/commonHeaders'
      payload:
        $ref: "#/components/schemas/aktivitetskort-bestilling"
  messageTraits:
    commonHeaders:
      headers:
        required:
          - Nav-Call-Id
        type: object
        properties:
          Nav-Call-Id:
            type: string
            minLength: 10
            description: brukes for logging og sporing på tvers av applikasjoner

  schemas:
    aktivitetskort-bestilling:
      required:
        - messageId
        - source
        - sendt
        - aktivitetskortType
        - aktiviteskort
        - actionType
      type: object
      properties:
        messageId:
          type: string
          format: uuid
          description: Unik id for denne meldingen brukes til deduplisering
        source:
          type: string
          description: Applikasjonen eller teamet som er avsender av meldingen.
        sendt:
          type: string
          format: date-time
        aktivitetskortType:
          $ref: "#/components/schemas/aktivitetskortType"
        actionType:
          $ref: "#/components/schemas/actionType"
        aktiviteskort:
          $ref: "#/components/schemas/aktivitetskort"

    actionType:
      type: string
      enum:
        - UPSERT_AKTIVITETSKORT_V1
      description: Actiontype forteller hvordan meldingen skal behandles.
        Forløpig har vi kun støtte for å opprette og oppdatere aktivitetskort.
    aktivitetskortType:
      type: string
      enum:
        - MIDLERTIDIG_LONNSTILSKUDD
        - VARIG_LONNSTILSKUDD
        - ARENA_TILTAK
      description: Aktivitetskort typer som er tillatt å opprette via tjenesten. Denne enumereringen vil utvides etterhvert.
    oppgave:
      type:
        - object
        - 'null'
      properties:
        tekst:
          type: string
        subtekst:
          type: string
        url:
          type: string
          format: url
      description: En oppgave vil bli rendret som et alert-panel med en lenke i aktivitetskortet. Dette signaliserer at det er en oppgave bruker eller veileder trenger å gjøre (f.eks. signere en avtale). Selve handlingen vil utføres i et annet system enn aktivitetsplan, og vil typisk resultere i en ny versjon av aktiviteten med oppdatert status sendes inn på denne tjenesten.
    lenkeseksjon:
      type: object
      properties:
        tekst:
          type: string
        subtekst:
          type: string
        url:
          type: string
          format: url
        lenkeType:
          type: string
          enum:
            - EKSTERN
            - INTERN
            - FELLES
    attributt:
      type: object
      properties:
        label:
          type: string
        verdi:
          type: string
    aktivitetskort:
      type: object
      required:
        - id
        - personIdent
        - tittel
        - aktivitetStatus
        - endretAv
        - endretTidspunkt
        - avtaltMedNav
      properties:
        id:
          type: string
          format: uuid
          description: Funksjonell ID for aktiviteten er en globalt unik UUID for aktiviteten.
            Ved vellykket opprettelse av aktiviteten, vil aktiviteten kunne gjenfinnnes
            ved hjelp av denne iden. Senere modifisering av samme aktivitet vil også
            bruke denne iden for å identifisere korrekt aktivitet.
        personIdent:
          type: string
          examples:
            - '10068831950'
          description: Norsk identitetsnummer (d-nr eller f-nr) for personen som eier
            aktivitetskortet
        tittel:
          type: string
          description: Tittelen på aktivitetskortet
        aktivitetStatus:
          type: string
          enum:
            - FORSLAG
            - PLANLAGT
            - GJENNOMFORES
            - FULLFORT
            - AVBRUTT
          description: Dette feltet forteller hvilken status aktiviteten har, og dermed
            hvilken kolonne aktivitetskortet skal ligge i i aktivitetsplanen. Merk at
            aktivitetskort som er fullført eller avbrutt ikke kan endres i etterkant,
            da dette er en endelig status.
        startDato:
          type:
            - string
            - 'null'
          format: date
          examples:
            - '2022-03-01'
          description: Planlagt startdato for aktiviteten
        sluttDato:
          type:
            - string
            - 'null'
          format: date
          examples:
            - '2022-05-15'
          description: Planlagt sluttdato for aktiviteten
        beskrivelse:
          type:
            - string
            - 'null'
          description: Beskrivende tekst for aktiviteten
        endretAv:
          type: object
          required:
            - ident
            - identType
          description: Sporingsfelt som identifiserer hvem som oppretter eller endrer
            aktiviteten
          properties:
            ident:
              type: string
              examples:
                - Z999999
              description: Id til bruker som oppretter eller endrer aktiviteten
            identType:
              type: string
              enum:
                - ARENAIDENT
                - NAVIDENT
                - PERSONBRUKER
              description: Type ident. Kan være navIdent, arenaIdent, på sikt kanskje
                tiltaksarrangør, arbeidsgiver eller eksternBruker
          examples:
            - ident: AAA123
              identType: ARENAIDENT
        endretTidspunkt:
          type: string
          format: date-time
          examples:
            - '2022-09-17T21:00:14'
          description: Dato-tid for opprettelse eller endring i kildesystemet
        avtaltMedNav:
          type: boolean
          description: Hvorvidt aktiviteten skal bli markert som 'Avtalt med NAV'. Dette
            gjelder typisk aktiviteter med aktivitetsplikt.
        avsluttetBegrunnelse:
          type:
            - string
            - 'null'
          description: Ved avbrudd i aktiviteten, kan det legges til en begrunnelse
            for avbrytelsen.
        oppgave:
          type:
            - object
            - 'null'
          properties:
            ekstern:
              "$ref": "#/components/schemas/oppgave"
            intern:
              "$ref": "#/components/schemas/oppgave"
        handlinger:
          type:
            - array
            - 'null'
          items:
            "$ref": "#/components/schemas/lenkeseksjon"
          description: Handlinger vil rendres som lenkeseksjoner i aktivitetskortet. Dette kan brukes for å tilby tilleggsfunksjonalitet i kildesystemet, f.eks. Les avtalen, Evaluer deltakelsen på tiltaket, o.l.
        detaljer:
          type: array
          items:
            "$ref": "#/components/schemas/attributt"
          description: For å vise selvdefinerte informasjonsfelter på aktivitetskortet. Disse rendres som enkle label/tekst komponenter i samme rekkefølge som de ligger i meldingen.
        etiketter:
          type: array
          items:
            type: object
            properties:
              kode:
                type: string
          description: Etiketter rendres som etiketter (Tags) på aktivitetskortet. Koden som sendes inn må mappes om til tekst + korrekt styling i aktivitetsplanen, så DAB trenger å vite hvilke koder som er aktuelle på forhånd.
